#!/usr/bin/python
import sys
import os

# Import Atarashii -------------------------------------------------------------
sys.path.insert(0, "/usr/share/pyshared")
try:
    import atarashii
    
except:
    if sys.path[0] == "/usr/share/pyshared": 
        sys.path.pop(0)
        
    sys.exit(os.EX_TEMPFAIL)

# Check what we should start ----------------------------------------------------
arg = ""
if len(sys.argv) == 2:
    arg = sys.argv[1]

# Application
if arg == "main":
    atarashii.start()

# Crash Wrapper
else:
    if arg == "auto":
        import time
        time.sleep(3)
    
    # Wrap arround crazy random GDK and XOrg Erros ^.^"
    import subprocess
    restart_max = 2
    restart_count = 0
    while True:
        print "Starting Atarashii..."
        error = subprocess.call(["atarashii", "main"])
        if error == os.EX_UNAVAILABLE:
            print "Atarashii is already running"
            break
        
        elif error == os.EX_TEMPFAIL:
            print "Importing Atarashii failed"
            break
        
        # Detect normal exit
        elif error in (os.EX_OK, -15, -9): 
            print "Atarashii has been closed with status %d" % error
            break
        
        else:
            atarashii.crash(error)
            if restart_count >= restart_max:
                break
            
            restart_count += 1
            print "Atarashii crashed with %d! Restart #%d/%d" \
                   % (error, restart_count, restart_max) 
    
    exit(error)

